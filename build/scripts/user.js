import*as j from"../_snowpack/env.js";console.log("%cD2 SYNERGY","font-weight: bold;font-size: 40px;color: white;"),console.log("// Welcome to D2Synergy, Please report any errors to @beru2003 on Twitter.");import k from"../_snowpack/pkg/axios.js";import{ValidateManifest as ie,ReturnEntry as L}from"./utils/ValidateManifest.js";import{VerifyState as re,ParseChar as le,StartLoad as ce,StopLoad as de,MakeBountyElement as pe,RedirUser as F,InsertSeperators as T,ParseBounties as me,PushToDOM as he,SortByGroup as ue,SortByType as ye,SortBountiesByType as fe,CalcXpYield as ge,ReturnSeasonProgressionStats as Ie,ReturnSeasonPassLevel as we,LoadPrimaryCharacter as ke,CacheAuditItem as Q,AddNumberToElementInner as o,CreateFilters as Te}from"./utils/ModuleScript.js";import{itemTypeKeys as Z,vendorKeys as ee,baseYields as be,petraYields as Pe}from"./utils/SynergyDefinitions.js";import{bountyPropCount as Be,PushProps as Ee}from"./utils/MatchProps.js";import{AddEventListeners as Se}from"./utils/Events.js";re();var _e=new URLSearchParams(window.location.search),E=window.sessionStorage,l=window.localStorage,S=console.log.bind(console),ve=new Date,R={},i={},te={},se={},K={},b={},U={},V={},Ce={},_,N,f,v=j.HOME_URL,$={ApiKey:j.API_KEY,Authorization:j.AUTH},Ae=j.CLIENT_ID;document.getElementById("navBarVersion").innerHTML=`${j.version}`,i.homeUrl=v,k.defaults.headers.common={"X-API-Key":`${$.ApiKey}`},i.charBounties=[],i.characters={},i.filterDivs={},i.bools={},i.ints={},i.objs={},i.objs.currView=document.getElementById("pursuitsContainer"),i.bools.characterLoadToggled=!1,i.bools.filterToggled=!1,Q("refreshInterval",5*6e4),ce();var Oe=async r=>{let n={},s={},t={},m={headers:{Authorization:`Basic ${$.Authorization}`,"Content-Type":"application/x-www-form-urlencoded"}};await k.post("https://www.bungie.net/platform/app/oauth/token/",`grant_type=authorization_code&code=${r}`,m).then(d=>{let c=d.data;t.membership_id=c.membership_id,t.token_type=c.token_type,t.authorization_code=r,n.inception=Math.round(new Date().getTime()/1e3),n.expires_in=c.expires_in,n.value=c.access_token,s.inception=Math.round(new Date().getTime()/1e3),s.expires_in=c.refresh_expires_in,s.value=c.refresh_token,l.setItem("accessToken",JSON.stringify(n)),l.setItem("components",JSON.stringify(t)),l.setItem("refreshToken",JSON.stringify(s)),S("-> Authorized with Bungie.net!")}).catch(d=>{d.response.data.error_description=="AuthorizationCodeInvalid"||d.response.data.error_description=="AuthorizationCodeStale"?window.location.href=`https://www.bungie.net/en/oauth/authorize?&client_id=${Ae}&response_type=code`:console.error(d)})},Y=async r=>{let n=JSON.parse(l.getItem("accessToken")),s=JSON.parse(l.getItem("refreshToken")),t=JSON.parse(l.getItem("components")),m={},d={},c={},C={headers:{Authorization:`Basic ${$.Authorization}`,"Content-Type":"application/x-www-form-urlencoded"}};var A=["value","inception","expires_in","membership_id","token_type","authorization_code"],O=["membership_id","token_type","authorization_code"],P=["inception","expires_in","value"];Object.keys(s).forEach(a=>{A.includes(a)||(delete s[a],l.setItem("refreshToken",JSON.stringify(s)))}),Object.keys(n).forEach(a=>{A.includes(a)||(delete n[a],l.setItem("accessToken",JSON.stringify(n)))}),Object.keys(t).forEach(a=>{A.includes(a)||(delete t[a],l.setItem("components",JSON.stringify(t)))}),Object.keys(P).forEach(a=>{Object.keys(s).includes(P[a])||F(v,"rsToken=true"),Object.keys(n).includes(P[a])||F(v,"acToken=true")}),Object.keys(O).forEach(a=>{Object.keys(t).includes(O[a])||F(v,"comps=true")});let w=n.inception+n.expires_in<=Math.round(new Date().getTime()/1e3)-1,g=s.inception+s.expires_in<=Math.round(new Date().getTime()/1e3)-1;(w||g)&&(delete k.defaults.headers.common["X-API-Key"],document.getElementById("loadingText").innerHTML="Refreshing Tokens",S(w?"-> Access token expired..":"-> Refresh token expired.."),await k.post("https://www.bungie.net/Platform/App/OAuth/token/",`grant_type=refresh_token&refresh_token=${s.value}`,C).then(a=>{let p=a.data;c.membership_id=p.membership_id,c.token_type=p.token_type,c.authorization_code=t.authorization_code,d.inception=Math.round(new Date().getTime()/1e3),d.expires_in=p.expires_in,d.value=p.access_token,m.inception=Math.round(new Date().getTime()/1e3),m.expires_in=p.refresh_expires_in,m.value=p.refresh_token,l.setItem("accessToken",JSON.stringify(d)),l.setItem("components",JSON.stringify(c)),l.setItem("refreshToken",JSON.stringify(m))}),S(w?"-> Access Token Refreshed!":"-> Refresh Token Refreshed!")),r&&S("-> Tokens Validated!")},xe=async()=>{let r=JSON.parse(l.getItem("refreshToken")),n=JSON.parse(l.getItem("accessToken")),s=JSON.parse(l.getItem("components")),t=_e.get("code");window.history.pushState({},document.title,window.location.pathname);try{t&&(!s||!n||!r)?await Oe(t):!t&&(!s||!n||!r)?window.location.href=v:!t||t&&(s||n||r)?await Y():!t&&(s||n||r)?await Y():window.location.href=v}catch(m){console.error(m)}},De=async()=>{let r=JSON.parse(l.getItem("components")),n={headers:{Authorization:`Bearer ${JSON.parse(l.getItem("accessToken")).value}`,"X-API-Key":`${$.ApiKey}`}};if(document.getElementById("loadingText").innerHTML="Fetching User Details",N=E.getItem("membershipType"),_=JSON.parse(E.getItem("destinyMembershipId")),b=JSON.parse(E.getItem("destinyUserProfile")),!N||!_||!b){let s=await k.get(`https://www.bungie.net/Platform/Destiny2/1/Profile/${r.membership_id}/LinkedProfiles/?getAllMemberships=true`,n);_=s.data.Response.profiles[0].membershipId,N=s.data.Response.profiles[0].membershipType,b=(await k.get(`https://www.bungie.net/Platform/Destiny2/${N}/Profile/${_}/?components=200`,n)).data.Response,E.setItem("membershipType",N),E.setItem("destinyMembershipId",JSON.stringify(_)),E.setItem("destinyUserProfile",JSON.stringify(b))}if(N&&_&&b){f=b.characters.data;for(let s in f){let t=f[s];document.getElementById(`classBg${t.classType}`).src=`https://www.bungie.net${t.emblemBackgroundPath}`,document.getElementById(`classType${t.classType}`).innerHTML=`${le(t.classType)}`,document.getElementById(`classLight${t.classType}`).innerHTML=`${t.light}`}i.characters=f,document.getElementById("charactersContainer").style.display="inline-block",document.getElementById("categories").style.display="block",document.getElementById("statsContainer").style.display="block"}},Le=async(r,n)=>{if(!i.characterLoadToggled){document.getElementById("loadingText").innerHTML="Indexing Character",await Y(!1);let s=E.getItem("membershipType"),t,m,d,c,C={},A=0,O,P,w,g=[],a={},p,J;i.characterLoadToggled=!0,Q("lastChar",r),document.getElementById("loadingContentContainer").style.display="block",document.getElementById("contentDisplay").style.display="none",document.getElementById("noItemsTooltip").style.display="none",document.getElementById("bountyItems").innerHTML="",document.getElementById("overlays").innerHTML="",document.getElementById("filters").innerHTML="";for(let e in f)f[e].classType!==r?document.getElementById(`charContainer${f[e].classType}`).classList.add("elBlur"):f[e].classType===r&&document.getElementById(`charContainer${f[e].classType}`).classList.remove("elBlur"),document.getElementById(`charContainer${f[e].classType}`).style.display="block";for(let e in b.characters.data){let y=b.characters.data[e];y.classType===r&&(p=y.characterId)}if(!R.resCharacterInventories||n){let e={headers:{Authorization:`Bearer ${JSON.parse(l.getItem("accessToken")).value}`,"X-API-Key":`${$.ApiKey}`}},y=await k.get(`https://www.bungie.net/Platform/Destiny2/${s}/Profile/${_}/?components=100,104,201,202,205,300,301,305`,e),h=y.data.Response;m=h.characterInventories.data,w=h.profile.data.currentSeasonHash,t=h.characterProgressions.data[p].progressions,d=h.itemComponents.objectives.data,O=h.characterEquipment.data[p].items,c=h.profileProgression.data,J=h.itemComponents.sockets.data,R.resCharacterInventories=y}else if(R.resCharacterInventories){let e=R.resCharacterInventories.data.Response;m=e.characterInventories.data,w=e.profile.data.currentSeasonHash,t=e.characterProgressions.data[p].progressions,d=e.itemComponents.objectives.data,O=e.characterEquipment.data[p].items,c=e.profileProgression.data,J=e.itemComponents.sockets.data}let oe=m[p].items,M=0,B={};ee.forEach(e=>{B[e]=[]});let W=me(oe,d,{definitions:V,objectiveDefinitions:K});g=W[0],M=W[1],Object.keys(g).forEach(e=>{let y=g[e].objectives.objectiveHashes;g[e].objectiveDefinitions=[];for(let h of y)g[e].objectiveDefinitions.push(K[h])}),B=ue(g,{bountyArr:B,vendorKeys:ee,itemTypeKeys:Z}),B=ye(B,{SortBountiesByType:fe}),he(B,{MakeBountyElement:pe,amountOfBounties:M}),i.charBounties=g;let X=ge(B,{itemTypeKeys:Z,baseYields:be,petraYields:Pe}),I=0;O.forEach(e=>{if(e.bucketHash===4023194814){let y=J[e.itemInstanceId].sockets;Object.keys(y).forEach(h=>{let D=y[h].plugHash;D===1820053069?I=2:D===1820053068?I=3:D===1820053071?I=5:D===1820053070?I=8:D===1820053065?I=10:D===1820053064&&(I=12)})}}),a=t[U[w].seasonPassProgressionHash],C=se[U[w].seasonPassHash],P=t[C.prestigeProgressionHash],A=await we(a,P);let ne=te[C.rewardProgressionHash].rewardItems,H={};ne.forEach(e=>{H[e.rewardedAtProgressionLevel]||(H[e.rewardedAtProgressionLevel]=[]),H[e.rewardedAtProgressionLevel].push(e.itemHash)});let u=await Ie(a,P,H,V),z=u[3]+12;o("XpToNextEngram",T(u[0])),o("totalBrightEngramsEarned",T(u[1])),o("seasonPassFireteamBonus",`${u[2]}%`),o("seasonPassXpBonus",`${z}%`),o("bonusXpValue",`${z}%`),o("sharedWisdomValue",`${u[2]}%`),o("ghostModValue",`${I}%`);let ae=X*((z+u[2]+I)/100+1);o("totalNetXpField",`${T(ae)}`),o("seasonPassRankLevel",A),o("seasonPassXpToNextRank",T(u[4])),o("seasonPassXpToMaxRank",T(u[5]));let q=0,G=0;for(let e of i.charBounties)e.isComplete&&G++,e.isExpired&&q++;o("expiredBountiesAmountField",q),o("completedBountiesAmountField",G),o("currentSeasonNameField",C.displayProperties.name),I||(document.getElementById("ghostModCheckmark").style.display="none",document.getElementById("ghostModCross").style.display="inline-block"),u[2]||(document.getElementById("sharedWisdomCheckmark").style.display="none",document.getElementById("sharedWisdomCross").style.display="inline-block"),u[3]||(document.getElementById("bonusXpCheckmark").style.display="none",document.getElementById("bonusXpCross").style.display="inline-block");let x;c.seasonalArtifact?(x=c.seasonalArtifact,o("artifactStatsArtifactBonus",`+${x.powerBonus}`),o("artifactXpToNextUnlock",T(x.pointProgression.nextLevelAt-x.pointProgression.progressToNextLevel)),o("artifactXpToNextPowerBonus",T(x.powerBonusProgression.nextLevelAt-x.powerBonusProgression.progressToNextLevel))):c.seasonalArtifact||(document.getElementById("artifactStatsFirstContainer").style.display="none",document.getElementById("artifactStatsSecondContainer").style.display="none",document.getElementById("artifactStatsThirdMetricContainer").style.display="none",document.getElementById("artifactStatsNoArtifactIsPresent").style.display="block"),M===0?(document.getElementById("noItemsTooltip").innerHTML="You don't have bounties on this character. How dare you. (-(-_(-_-)_-)-)",document.getElementById("noItemsTooltip").style.display="inline-block",o("totalXpField",0),o("totalSpLevelsField",0),o("bountiesAmountField",0)):M>0&&(o("bountiesAmountField",`${M}`),o("totalXpField",T(X)),o("totalSpLevelsField",X/1e5)),await Ee(),await Te("charBounties",Be),i.characterLoadToggled=!1,de(),i.objs.currView.style.display="block",document.getElementById("contentDisplay").style.display="inline-block"}};(async()=>{await xe(),k.defaults.headers.common={"X-API-Key":`${$.ApiKey}`},await ie(),await De(),U=await L("DestinySeasonDefinition"),se=await L("DestinySeasonPassDefinition"),te=await L("DestinyProgressionDefinition"),K=await L("DestinyObjectiveDefinition"),V=await L("DestinyInventoryItemDefinition"),Ce=await L("DestinyPlugSetDefinition"),await ke(i.characters),await Se(),S(`-> OAuth Flow Complete! [Elapsed: ${new Date-ve}ms]`)})().catch(r=>{console.error(r)});export{Le as LoadCharacter,i as userStruct,v as homeUrl};
